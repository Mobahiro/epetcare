{% extends 'vet_portal/dashboard_base.html' %}
{% load static %}
{% block title %}Patients - ePetCare Vet Portal{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'clinic/dashboard-common.css' %}?v={% now 'U' %}">
<style>
  /* Mobile fixes for patient list */
  @media (max-width: 640px) {
    .card-head {
      flex-direction: column !important;
      align-items: flex-start !important;
      gap: 12px !important;
    }
    .card-head h2 {
      margin-bottom: 0;
    }
    .head-actions {
      width: 100%;
    }
    .head-actions form {
      flex-direction: column !important;
      width: 100%;
    }
    .head-actions input[type="search"] {
      min-width: unset !important;
      width: 100% !important;
      box-sizing: border-box;
    }
    .head-actions .btn {
      width: 100%;
    }
  }
  
  /* Hide cards that don't match search */
  .pet-card.hidden {
    display: none !important;
  }
</style>
{% endblock %}

{% block dash_content %}
<!-- Hero section -->
<section class="dash-hero">
  <div class="hero-main">
    <div class="hero-title-row">
      <h1 class="hero-title">Patients</h1>
    </div>
    <div class="hero-meta-line">
      <span class="meta-item patient-count-text">{{ patients.count }} patient{{ patients.count|pluralize }} under your care</span>
    </div>
  </div>
  <div class="hero-divider"></div>
</section>

<!-- Main card with patients -->
<div class="main-card">
  <div class="card-head">
    <h2>All Patients</h2>
    <div class="head-actions">
      <div style="display: flex; gap: 8px; align-items: center;">
        <input type="search" id="patient-search" placeholder="Search by name, owner, species, breed..." value="{{ request.GET.search }}" style="padding: 8px 12px; border: 1px solid var(--dash-divider); border-radius: 8px; min-width: 300px;">
      </div>
    </div>
  </div>
  
  <div class="pet-grid" id="patient-grid">
    {% for p in patients %}
      <div class="pet-card" data-name="{{ p.name|lower }}" data-owner="{{ p.owner.full_name|lower }}" data-species="{{ p.get_species_display_full|lower|default:'' }}" data-breed="{{ p.breed|lower|default:'' }}">
        <div class="pet-card-header">
          {% if p.image_url or p.image %}
            <img src="{{ p.image_url|default:p.image.url }}" alt="{{ p.name }}" class="pet-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div class="pet-image-placeholder" style="display:none;">{{ p.name|slice:':1'|upper }}</div>
          {% else %}
            <div class="pet-image-placeholder">{{ p.name|slice:':1'|upper }}</div>
          {% endif %}
          <div class="pet-info">
            <div class="pet-name">{{ p.name }}</div>
            <div class="pet-species">{{ p.get_species_display_full|default:"Unknown" }}{% if p.breed %} â€¢ {{ p.breed }}{% endif %}</div>
          </div>
        </div>
        <div class="pet-card-body" style="padding: 12px 16px; border-top: 1px solid var(--dash-divider);">
          <div style="display: flex; flex-direction: column; gap: 6px; font-size: 13px; color: var(--dash-text-muted);">
            <div><strong>Owner:</strong> {{ p.owner.full_name }}</div>
            {% if p.sex %}<div><strong>Sex:</strong> {{ p.get_sex_display }}</div>{% endif %}
            {% if p.weight_kg %}<div><strong>Weight:</strong> {{ p.weight_kg }} kg</div>{% endif %}
          </div>
        </div>
        <div class="pet-card-actions">
          <a href="{% url 'vet_portal:patient_detail' p.id %}" class="pet-action">View Details</a>
        </div>
      </div>
    {% empty %}
      <div class="empty-message" style="grid-column: 1/-1;">
        <p style="margin: 40px 0; font-size: 15px;">No patients found matching your search.</p>
      </div>
    {% endfor %}
  </div>
  
  <!-- No results message (shown when all cards are filtered out) -->
  <div id="no-results" class="empty-message" style="display: none; grid-column: 1/-1;">
    <p style="margin: 40px 0; font-size: 15px;">No patients found matching your search.</p>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
  const searchInput = document.getElementById('patient-search');
  const patientGrid = document.getElementById('patient-grid');
  const noResults = document.getElementById('no-results');
  const countText = document.querySelector('.patient-count-text');
  const allCards = patientGrid ? patientGrid.querySelectorAll('.pet-card[data-name]') : [];
  const totalCount = allCards.length;
  
  if (!searchInput || !patientGrid || allCards.length === 0) return;
  
  function filterPatients() {
    const query = searchInput.value.toLowerCase().trim();
    let visibleCount = 0;
    
    allCards.forEach(card => {
      const name = card.dataset.name || '';
      const owner = card.dataset.owner || '';
      const species = card.dataset.species || '';
      const breed = card.dataset.breed || '';
      
      // Check if any field contains the search term
      const matches = !query || 
        name.includes(query) || 
        owner.includes(query) || 
        species.includes(query) || 
        breed.includes(query);
      
      if (matches) {
        card.classList.remove('hidden');
        visibleCount++;
      } else {
        card.classList.add('hidden');
      }
    });
    
    // Show/hide no results message
    if (noResults) {
      noResults.style.display = visibleCount === 0 ? 'block' : 'none';
    }
    
    // Update count text
    if (countText) {
      if (query) {
        countText.textContent = `${visibleCount} of ${totalCount} patient${totalCount !== 1 ? 's' : ''} matching "${searchInput.value}"`;
      } else {
        countText.textContent = `${totalCount} patient${totalCount !== 1 ? 's' : ''} under your care`;
      }
    }
  }
  
  // Listen for input changes (real-time filtering)
  searchInput.addEventListener('input', filterPatients);
  
  // Also filter on page load if there's a search value
  if (searchInput.value) {
    filterPatients();
  }
})();
</script>
{% endblock %}
