{% extends 'clinic/dashboard_base.html' %}
{% load static %}
{% block title %}Appointments - ePetCare{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'clinic/dashboard-common.css' %}?v={% now 'U' %}">
{% endblock %}

{% block dash_content %}
<!-- Hero section -->
<section class="dash-hero">
  <div class="hero-main">
    <div class="hero-title-row">
      <h1 class="hero-title">Appointments</h1>
      <a class="btn btn-primary" href="{% url 'appointment_create' %}">+ New</a>
    </div>
    <div class="hero-meta-line">
      <span class="meta-item">Manage your pet's clinic visits.</span>
    </div>
  </div>
  <div class="hero-divider"></div>
</section>

<!-- Summary tiles -->
<section class="summary-tiles">
  <div class="tile">
    <div class="tile-head">
      <div class="tile-icon">üìÖ</div>
      <div class="tile-text">
        <div class="tile-title">Upcoming</div>
        <div class="tile-sub">Scheduled</div>
      </div>
    </div>
    <div class="tile-metric">{{ upcoming_count|default:"0" }}</div>
  </div>
  <div class="tile">
    <div class="tile-head">
      <div class="tile-icon">‚úì</div>
      <div class="tile-text">
        <div class="tile-title">Completed</div>
        <div class="tile-sub">Past visits</div>
      </div>
    </div>
    <div class="tile-metric">{{ completed_count|default:"0" }}</div>
  </div>
  <div class="tile">
    <div class="tile-head">
      <div class="tile-icon">üóìÔ∏è</div>
      <div class="tile-text">
        <div class="tile-title">Total</div>
        <div class="tile-sub">All appointments</div>
      </div>
    </div>
    <div class="tile-metric">{{ appointments|length }}</div>
  </div>
</section>

<div class="filter-bar animate-slideDown delay-100">
  <div class="filter-group">
    <label for="status-filter">Status:</label>
    <select id="status-filter" class="form-control">
      <option value="all">All</option>
      <option value="scheduled">Scheduled</option>
      <option value="completed">Completed</option>
      <option value="cancelled">Cancelled</option>
    </select>
  </div>
  <div class="filter-group">
    <label for="date-range">Date Range:</label>
    <select id="date-range" class="form-control">
      <option value="all">All dates</option>
      <option value="upcoming">Upcoming</option>
      <option value="past">Past</option>
      <option value="today">Today</option>
      <option value="week">This week</option>
      <option value="month">This month</option>
    </select>
  </div>
</div>

<div class="dash-grid">
  <div class="main-card">
    <div class="card-head">
      <h2>Upcoming Appointments</h2>
      <div class="head-actions">
        <a class="btn btn-primary btn-sm" href="{% url 'appointment_create' %}">+ New</a>
      </div>
    </div>

    <div class="list animate-slideUp delay-200">
      {% for a in appointments %}
        {% if a.status == 'scheduled' %}
          <div class="list-item" data-status="{{ a.status }}">
            <div class="appointment-card-header">
              <div class="appointment-date-container">
                <div class="appointment-date">
                  <div class="date-day">{{ a.date_time|date:"d" }}</div>
                  <div class="date-month">{{ a.date_time|date:"M" }}</div>
                </div>
                <div class="appointment-time">{{ a.date_time|date:"H:i" }}</div>
              </div>
              <div class="appointment-status">
                <span class="status-pill scheduled">Scheduled</span>
              </div>
            </div>
            <div class="appointment-card-body">
              <div class="appointment-pet-info">
                <div class="pet-icon">{{ a.pet.name|slice:":1"|upper }}</div>
                <div class="pet-details">
                  <div class="pet-name">{{ a.pet.name }}</div>
                  <div class="pet-species">{{ a.pet.get_species_display }}</div>
                </div>
              </div>
              <div class="appointment-reason-box">
                <div class="reason-label">Reason for visit:</div>
                <div class="reason-text">{{ a.reason }}</div>
              </div>
            </div>
            <div class="appointment-card-footer">
              <a href="#" class="card-action">Change Status</a>
              <a href="#" class="card-action">Reschedule</a>
              <a href="#" class="card-action danger">Cancel</a>
            </div>
          </div>
        {% endif %}
      {% endfor %}

      {% if not appointments|dictsortreversed:"date_time"|first %}
        <div class="empty-message">
          <div>No upcoming appointments.</div>
          <a class="btn-link" href="{% url 'appointment_create' %}">Schedule your first appointment</a>
        </div>
      {% endif %}
    </div>
  </div>

  <aside class="col-right">
    <div class="rail">
      <div class="rail-card">
        <div class="rail-title">Next Appointment</div>
        {% with next_appt=appointments|dictsortreversed:"date_time"|first %}
          {% if next_appt %}
            <div class="rail-row">
              <div class="rail-primary">{{ next_appt.date_time|date:"M d, Y H:i" }}</div>
              <div class="rail-secondary">{{ next_appt.pet.name }}</div>
            </div>
            <div>
              <span class="pill scheduled">{{ next_appt.reason|truncatechars:30 }}</span>
            </div>
            <div class="rail-actions" style="margin-top:8px">
              <a class="btn btn-sm" href="#">View Details</a>
            </div>
          {% else %}
            <div class="empty-message">No upcoming appointments.</div>
          {% endif %}
        {% endwith %}
      </div>

      <div class="rail-card">
        <div class="rail-title">Quick Actions</div>
        <div class="rail-actions">
          <a class="btn btn-primary btn-sm" href="{% url 'appointment_create' %}">New Appointment</a>
        </div>
      </div>
    </div>
  </aside>
</div>

<div class="table-responsive desktop-only animate-fadeIn delay-300">
  <table class="appointment-table">
    <thead>
      <tr>
        <th>Date & Time</th>
        <th>Pet</th>
        <th>Reason</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for a in appointments %}
        <tr>
          <td>
            <div class="table-date">{{ a.date_time|date:"Y-m-d" }}</div>
            <div class="table-time">{{ a.date_time|date:"H:i" }}</div>
          </td>
          <td>{{ a.pet.name }}</td>
          <td>{{ a.reason }}</td>
          <td>
            {% if a.status == 'scheduled' %}
              <span class="badge scheduled">Scheduled</span>
            {% elif a.status == 'completed' %}
              <span class="badge completed">Completed</span>
            {% elif a.status == 'cancelled' %}
              <span class="badge cancelled">Cancelled</span>
            {% else %}
              <span class="badge">{{ a.get_status_display }}</span>
            {% endif %}
          </td>
          <td class="actions-cell">
            <div class="table-actions">
              <a href="#" class="table-action">Edit</a>
              <a href="#" class="table-action danger">Cancel</a>
            </div>
          </td>
        </tr>
      {% empty %}
        <tr><td colspan="5" class="empty-cell">No appointments scheduled.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Filter functionality
    const statusFilter = document.getElementById('status-filter');
    const dateFilter = document.getElementById('date-range');
    const appointmentCards = document.querySelectorAll('.appointment-card');

    function filterAppointments() {
      const statusValue = statusFilter.value;
      const dateValue = dateFilter.value;

      appointmentCards.forEach(card => {
        const status = card.dataset.status;
        let showCard = true;

        // Filter by status
        if (statusValue !== 'all' && status !== statusValue) {
          showCard = false;
        }

        // For demo purposes, we're just implementing the status filter
        // In a real app, you would also filter by date here

        card.style.display = showCard ? 'block' : 'none';
      });
    }

    if (statusFilter && dateFilter) {
      statusFilter.addEventListener('change', filterAppointments);
      dateFilter.addEventListener('change', filterAppointments);
    }
  });
 </script>
{% endblock %}

